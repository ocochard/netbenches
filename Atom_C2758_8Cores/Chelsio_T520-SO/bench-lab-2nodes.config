#!/bin/sh
# Configuration example for forwarding/routing performance with netmap pkt-gen:
#
#            ------admin network: 192.168.100.0/24 (ssh)----------
#              | .4                                        | .46
#+------------------------------------------+ +-------+ +------------------------------+
#|        Device under test                 | |switch | | Packet generator & receiver  |
#|                                          | |       | |                              |
#|                cxl0: 198.18.0.4/24       |=|   <   |=| ix0: 198.18.0.2/24           |
#|                      2001:2::4/64        | |       | |        2001:2::2/64          |
#|                      (00:07:43:3b:11:30) | |       | |        (00:25:90:91:14:0a)   |
#|                                          | |       | |                              |
#|                cxl1: 198.19.0.4/24       |=|   >   |=| ix1: 198.19.0.2/24           |
#|                      2001:2:0:8000::4/64 | |       | |        2001:2:0:8000::2/64   |
#|                      (00:07:43:3b:11:38) | +-------+ |        (00:25:90:91:14:0b)   |
#|                                          |           |                              |
#|            static routes                 |           |                              |
#| 192.18.0.0/16      => 198.18.0.46        |           |                              |
#| 192.19.0.0/16      => 198.19.0.46        |           |                              |
#| 2001:2::/49        => 2001:2::46         |           |                              |
#| 2001:2:0:8000::/49 => 2001:2:0:8000::46  |           |                              |
#|                                          |           |                              |
#|        static arp and ndp                |           |                              |
#| 198.18.0.2       => 00:25:90:91:14:0a    |           |                              |
#| 2001:2::2                                |           |                              |
#|                                          |           |                              |
#| 198.19.0.2        => 00:25:90:91:14:0b   |           |                              |
#| 2001:2:0:8000::2                         |           |                              |
#+------------------------------------------+           +------------------------------+

# Admin network IP
SENDER_ADMIN="bigone"
RECEIVER_ADMIN="bigone"
DUT_ADMIN="sm1"
REF_ADMIN=""

# LAB network IP and data
SENDER_LAB_IP="198.18.0.2"
RECEIVER_LAB_IP="198.19.0.2"

#netmap pkt-gen need these information:
SENDER_LAB_IF="ix0"
SENDER_LAB_IF_MAC="00:25:90:91:14:0a"
RECEIVER_LAB_IF="ix1"
RECEIVER_LAB_IF_MAC="00:25:90:91:14:0b"
DUT_LAB_IF_MAC_SENDER_SIDE="00:07:43:3b:11:30"
DUT_LAB_IF_MAC_RECEIVER_SIDE="00:07:43:3b:11:38"
#Generate about 2000 flows (20*100)
# source/dest IP and port can be modified
# Number of packet or packet size too
# Used for testing different value of flows as examples
: ${AF:="4"}
: ${SENDER_LAB_NET:="198.18.10.1:2001-198.18.10.71"}
: ${RECEIVER_LAB_NET:="198.19.10.1:2001-198.19.10.70"}
: ${PKT_TO_SEND:="1000000000"}

# Netmap pkt size didn't include CRC (4 Bytes)
# RFC2544 ask to try with:
# 64, 128, 256, 512, 1024, 1280, 1518
# This mean for netmap pktgen:
# 60, 124, 252, 508, 1020, 1276, 1514
# But need to add 2 for inet6
: ${PKT_SIZE:="43"}

# PMC event to collect
: ${PMC_EVENT:="cpu_clk_unhalted.core_p"}

#Timeout: Number of seconds / 5 to wait before declaring a problem for DUT rebooting process
REBOOT_TIMEOUT=120

#Is DUT online: Test command (fill switch MAC table and ARP cache)
IS_DUT_ONLINE_TARGET=${DUT_ADMIN}
IS_DUT_ONLINE_CMD="ping -c 2 ${RECEIVER_LAB_IP} && ping -c 2 ${SENDER_LAB_IP}"
#IS_DUT_ONLINE_CMD="ping -c 2 ${RECEIVER_LAB_IP} && ping -c 2 ${SENDER_LAB_IP} && /data/reqroutes 816800"

#Bench commands
RECEIVER_START_CMD="sudo pkt-gen -N -f rx -i ${RECEIVER_LAB_IF} -w 2 -W"
RECEIVER_STOP_CMD="sudo pgrep -q pkt-gen && sudo pkill pkt-gen"
SENDER_START_CMD="sudo pkt-gen -N -f tx -w 2 -i ${SENDER_LAB_IF} -n ${PKT_TO_SEND} \
-${AF} -d ${RECEIVER_LAB_NET} -D ${DUT_LAB_IF_MAC_SENDER_SIDE} -T 2000 \
-s ${SENDER_LAB_NET} -S ${SENDER_LAB_IF_MAC} -l ${PKT_SIZE}"
