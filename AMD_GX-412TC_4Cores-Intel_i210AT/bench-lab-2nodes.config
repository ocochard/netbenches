#!/bin/sh
# Configuration example for forwarding/routing performance with netmap pkt-gen:
# -------------------admin network: 192.168.100.0/24 (ssh)--------
#             | .42                                          | .4
# +------------------------------------------+      +-----------------------+
# |             Device under Test            |      |       Packet gen      |
# |                                          |      |                       |
# |                igb1:    198.18.0.205/24  |<=====| igb1: 198.18.0.203/24 |
# |                            2001:2::8/64  |      |        2001:2::203/64 |
# |                       00:0d:b9:41:ca:3d  |      |     0c:c4:7a:ab:29:35 |
# |                                          |      |                       |
# |               igb2:     198.19.0.205/24  |=====>| igb2: 198.19.0.203/24 |
# |                     2001:2:0:8000::8/64  |      | 2001:2:0:8000::203/64 |
# |                       00:0d:b9:41:ca:3e  |      |     0c:c4:7a:ab:29:36 |
# |                                          |      |                       |
# |               static routes              |      |                       |
# |      198.19.0.0/16 => 198.19.0.203       |      |                       |
# |      198.18.0.0/16 => 198.18.0.203       |      |                       |
# | 2001:2::/49        => 2001:2::203        |      |                       |
# | 2001:2:0:8000::/49 => 2001:2:0:8000::203 |      |                       |
# |                                          |      |                       |
# |            static arp and ndp            |      |                       |
# | 198.18.0.203        => 0c:c4:7a:ab:29:35 |      |                       |
# | 2001:2::203                              |      |                       |
# |                                          |      |                       |
# | 198.19.0.203        => 0c:c4:7a:ab:29:35 |      |                       |
# | 2001:2:0:8000::203                       |      |                       |
# +------------------------------------------+      +-----------------------+


# Admin network IP
SENDER_ADMIN="192.168.100.4"
RECEIVER_ADMIN="192.168.100.4"
DUT_ADMIN="192.168.100.42"
REF_ADMIN=""

# LAB network IP and data
SENDER_LAB_IP="198.18.0.203"
RECEIVER_LAB_IP="198.19.0.203"

#netmap pkt-gen need these information:
SENDER_LAB_IF="igb1"
SENDER_LAB_MAC="0c:c4:7a:ab:29:35"
RECEIVER_LAB_IF="igb2"
DUT_LAB_IF_MAC_SENDER_SIDE="00:0d:b9:41:ca:3d"
# source/dest IP and port can be modified
# Number of packet or packet size too
# Used for testing different value of flows as examples
: ${AF:="4"}
: ${SENDER_LAB_NET:="198.18.10.1:2001-198.18.10.20"}
: ${RECEIVER_LAB_NET:="198.19.10.1:2001-198.19.10.100"}
: ${PKT_TO_SEND:="80000000"}
# Netmap pkt size didn't include CRC (4 Bytes)
# RFC2544 ask to try with:
# 64, 128, 256, 512, 1024, 1280, 1518
# This mean for netmap pktgen:
# 60, 124, 252, 508, 1020, 1276, 1514
: ${PKT_SIZE:="60"}

#PMC event
: ${PMC_EVENT:="BU_CPU_CLK_UNHALTED"}

#Timeout : Number of seconds / 5 to wait before declaring a problem for DUT rebooting process
REBOOT_TIMEOUT=60

#Is DUT forwarding: Test command
IS_DUT_ONLINE_TARGET=${DUT_ADMIN}
IS_DUT_ONLINE_CMD="ping -c 2 ${RECEIVER_LAB_IP} && ping -c 2 ${SENDER_LAB_IP}"
# Example to wait for DUT to load all routes
# script reqroutes return true is number of routes greater or equal than the argument
#IS_DUT_ONLINE_CMD="ping -c 2 ${RECEIVER_LAB_IP} && ping -c 2 ${SENDER_LAB_IP} && /data/reqroutes 816800"

#Bench commands
RECEIVER_START_CMD="pkt-gen -N -f rx -i ${RECEIVER_LAB_IF} -w 2 -W"
RECEIVER_STOP_CMD="pkill pkt-gen"
SENDER_START_CMD="pkt-gen -f tx -N -i ${SENDER_LAB_IF} -n ${PKT_TO_SEND} -l ${PKT_SIZE} \
-${AF} -d ${RECEIVER_LAB_NET} -D ${DUT_LAB_IF_MAC_SENDER_SIDE} \
-s ${SENDER_LAB_NET} -S ${SENDER_LAB_MAC} -w 2"
#-U
